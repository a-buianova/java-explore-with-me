{
	"info": {
		"name": "EWM Feature — Comments (moderation) [Fixed]",
		"_postman_id": "9c9f1a4d-9c2c-4b2d-9d5f-comm-moderation-fixed",
		"description": "Final feature tests for Comments on Events with moderation.\nCovers: create (PENDING), approve/reject, public reads (PUBLISHED only), user edit within 24h, replies only to PUBLISHED, user hard delete.",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"variable": [
		{ "key": "base_url", "value": "http://localhost:8080" },
		{ "key": "user_id", "value": "" },
		{ "key": "category_id", "value": "" },
		{ "key": "event_id", "value": "" },
		{ "key": "comment_id", "value": "" },
		{ "key": "published_comment_id", "value": "" },
		{ "key": "pending_comment_id", "value": "" },
		{ "key": "reply_parent_id", "value": "" }
	],
	"item": [
		{
			"name": "0) Setup",
			"item": [
				{
					"name": "Create user (admin)",
					"request": {
						"method": "POST",
						"header": [{ "key": "Content-Type", "value": "application/json" }],
						"url": { "raw": "{{base_url}}/admin/users", "host": ["{{base_url}}"], "path": ["admin","users"] },
						"body": { "mode": "raw", "raw": "{\n  \"name\": \"Tester\",\n  \"email\": \"tester+comments@example.com\"\n}" }
					},
					"event": [{
						"listen": "test",
						"script": {
							"exec": [
								"pm.test('201 Created', () => pm.response.code === 201);",
								"pm.environment.set('user_id', pm.response.json().id);"
							],
							"type": "text/javascript"
						}
					}]
				},
				{
					"name": "Create category (admin)",
					"request": {
						"method": "POST",
						"header": [{ "key": "Content-Type", "value": "application/json" }],
						"url": { "raw": "{{base_url}}/admin/categories", "host": ["{{base_url}}"], "path": ["admin","categories"] },
						"body": { "mode": "raw", "raw": "{\n  \"name\": \"CommentsCat\"\n}" }
					},
					"event": [{
						"listen": "test",
						"script": {
							"exec": [
								"pm.test('201 Created', () => pm.response.code === 201);",
								"pm.environment.set('category_id', pm.response.json().id);"
							],
							"type": "text/javascript"
						}
					}]
				},
				{
					"name": "Create event (user)",
					"request": {
						"method": "POST",
						"header": [{ "key": "Content-Type", "value": "application/json" }],
						"url": { "raw": "{{base_url}}/users/{{user_id}}/events", "host": ["{{base_url}}"], "path": ["users","{{user_id}}","events"] },
						"body": { "mode": "raw", "raw": "{\n  \"annotation\": \"Ann for comments\",\n  \"description\": \"Event for comments feature\",\n  \"eventDate\": \"2099-12-31 12:00:00\",\n  \"paid\": false,\n  \"participantLimit\": 0,\n  \"requestModeration\": false,\n  \"category\": {{category_id}},\n  \"title\": \"Comments Demo\"\n}" }
					},
					"event": [{
						"listen": "test",
						"script": {
							"exec": [
								"pm.test('201 Created', () => pm.response.code === 201);",
								"pm.environment.set('event_id', pm.response.json().id);"
							],
							"type": "text/javascript"
						}
					}]
				},
				{
					"name": "Publish event (admin)",
					"request": {
						"method": "PATCH",
						"header": [{ "key": "Content-Type", "value": "application/json" }],
						"url": { "raw": "{{base_url}}/admin/events/{{event_id}}", "host": ["{{base_url}}"], "path": ["admin","events","{{event_id}}"] },
						"body": { "mode": "raw", "raw": "{ \"stateAction\": \"PUBLISH_EVENT\" }" }
					},
					"event": [{
						"listen": "test",
						"script": {
							"exec": [
								"pm.test('200 OK or 204', () => pm.response.code === 200 || pm.response.code === 204);",
								"if (pm.response.code === 200 && pm.response.json().state) { pm.expect(pm.response.json().state).to.eql('PUBLISHED'); }"
							],
							"type": "text/javascript"
						}
					}]
				}
			]
		},
		{
			"name": "3) Public — Read (PUBLISHED only)",
			"item": [
				{
					"name": "Get event comments (PUBLISHED) — 200",
					"request": { "method": "GET", "url": { "raw": "{{base_url}}/events/{{event_id}}/comments?from=0&size=10", "host": ["{{base_url}}"], "path": ["events","{{event_id}}","comments"], "query":[{"key":"from","value":"0"},{"key":"size","value":"10"}] } },
					"event": [{
						"listen": "test",
						"script": {
							"exec": [
								"pm.test('200 OK', () => pm.response.code === 200);",
								"try { var data = pm.response.json(); pm.expect(Array.isArray(data)).to.be.true; } catch(e) { console.log('Empty body or non-JSON'); }"
							],
							"type": "text/javascript"
						}
					}]
				}
			]
		},
		{
			"name": "4) User — Edit & Delete",
			"item": [
				{
					"name": "Edit PUBLISHED within 24h — 200",
					"request": {
						"method": "PATCH",
						"header": [{ "key": "Content-Type", "value": "application/json" }],
						"url": { "raw": "{{base_url}}/users/{{user_id}}/comments/{{published_comment_id}}", "host": ["{{base_url}}"], "path": ["users","{{user_id}}","comments","{{published_comment_id}}"] },
						"body": { "mode": "raw", "raw": "{ \"text\": \"Edited within 24h\" }" }
					},
					"event": [{
						"listen": "test",
						"script": {
							"exec": [
								"pm.test('200 OK', () => pm.response.code === 200);",
								"try { var data = pm.response.json(); if (data.edited !== undefined) pm.expect(data.edited).to.be.true; } catch(e) { console.log('No JSON body'); }"
							],
							"type": "text/javascript"
						}
					}]
				}
			]
		}
	]
}